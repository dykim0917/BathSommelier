# Care Branching Algorithm RFC (UI 미반영)

버전: v0.1 (Draft)  
기준 PRD: `/Users/exem/DK/BathSommelier/docs/PRD_CURRENT.md` (v3.10.2)  
문서 목적: 케어 알고리즘의 상태별 세부 분기안을 코드/화면 반영 전에 충돌 없이 정리하기 위한 기술 RFC.

## 1. 범위 및 비범위

### 1.1 범위
- 케어 추천 알고리즘의 세부 분기 입력/출력 계약 정의
- 상태별(A/B) 프로토콜 초안 정의
- 기존 ModeProtocol(sleep/reset/recovery)과의 충돌 규칙 정의
- 추후 구현 시 적용할 우선순위 정책 고정

### 1.2 비범위
- 앱 화면(UI/카피) 변경
- 라우팅/GNB/페이지 구조 변경
- 이벤트 스키마 변경
- 실제 엔진 코드 변경

## 2. 설계 원칙

1. 안전 필터 최우선  
- 모든 분기보다 `Safety`를 먼저 적용한다.

2. 사용자 환경 선택 존중  
- 안전 범위 내에서는 사용자 선택 환경(`욕조/샤워/부분입욕`)을 우선한다.

3. 상태 분기는 “권장”으로 동작  
- 분기에서 제안하는 환경/행동은 강제하지 않고, 충돌 시 대체안을 제공한다.

4. 초기 범위 제한  
- 1차 RFC 대상은 상태 8개 전체: `근육통`, `부종`, `감기 기운`, `생리통`, `숙취`, `불면`, `스트레스`, `우울`.

## 3. 입력 계약 (Draft)

```txt
CareBranchInput {
  care_primary_state: muscle_pain | swelling | cold_like | menstrual_pain | hangover | insomnia | stress | depression
  care_subtype: A | B
  environment_selected: bathtub | shower | partial_bath
  partial_bath_subtype?: low_leg | footbath
  health_flags: HealthCondition[]
  time_context: late_night | morning | day | evening
}
```

입력 방식 가정:
- 2단계 선택형
  - STEP1: 상태 선택
  - STEP2: 하위 유형(A/B) 선택

## 4. 출력 계약 (Draft)

```txt
CareBranchProtocol {
  mode_type: sleep | recovery | reset
  recommended_environment: bathtub | shower | partial_bath
  temp_pattern: string
  duration_range_min: [number, number]
  behavior_hint: string
  finish_hint: string
  fallback_note?: string
}
```

노출 강도 가정:
- 준비/진행/마무리 단계마다 핵심 행동 1개만 제공

## 5. 상태별 세부 분기 정의 (1차)

## 5.1 근육통

### A. 하체 중심
- 권장 환경: 저위 입욕/욕조
- 물 깊이: 무릎 위
- 온도: 따뜻~약간 뜨겁게
- 행동 힌트: 하체 중심 가동 동작 1개
- 마무리: 마지막 단계 온도 완만 하향

### B. 상체/목·어깨 중심
- 권장 환경: 반신욕/따뜻한 샤워
- 방향: 상체 집중
- 행동 힌트: 상체 회전·이완 동작 1개
- 마무리: 어깨 집중 온수 후 완만 하향

## 5.2 부종

### A. 하체 부종
- 권장 환경: 저위 입욕
- 물 깊이: 무릎 위
- 온도: 중간~따뜻
- 행동 힌트: 발목·종아리 펌핑 동작 1개
- 마무리: 종료 후 다리 상승 유지

### B. 전신 붓기 느낌
- 권장 환경: 욕조/샤워
- 온도 패턴: 일정 유지
- 행동 힌트: 짧은 단계형 전환 1회
- 마무리: 온도 완만 하향

## 5.3 불면

### A. 생각 많음형
- 권장 환경: 욕조
- 온도: 중간~따뜻
- 행동 힌트: 호흡 구간 1개 삽입
- 마무리: 조명 점진 감소

### B. 예민·각성형
- 권장 환경: 욕조
- 온도: 중간
- 행동 힌트: 리듬 최소화
- 마무리: 자극 요소 제거

## 5.4 스트레스

### A. 긴장 축적형
- 권장 환경: 욕조/샤워
- 온도: 따뜻
- 행동 힌트: 상체 이완 구간 1개
- 마무리: 부드러운 전환

### B. 과부하형(머리 복잡)
- 권장 환경: 욕조
- 온도: 중간
- 행동 힌트: 단순 단계 반복
- 마무리: 자극 최소화

## 5.5 감기 기운 (컨디션 저하)

### A. 몸살 느낌
- 권장 환경: 반신욕 우선
- 온도: 중간
- 시간: 짧은 루틴
- 행동 힌트: 안정형(리듬 낮음)
- 마무리: 급격한 온도 변화 없음

### B. 답답함 느낌
- 권장 환경: 따뜻한 샤워
- 온도: 중간
- 행동 힌트: 증기 유지 구간 1개 포함
- 마무리: 부드럽게 정리

## 5.6 생리통

### A. 하복부 중심
- 권장 환경: 반신욕
- 온도: 따뜻
- 행동 힌트: 하체 움직임 최소화
- 마무리: 온기 유지형 종료

### B. 허리 동반
- 권장 환경: 반신욕
- 온도: 따뜻
- 행동 힌트: 허리 이완 중심 루틴 1개
- 마무리: 상체 안정 유지

## 5.7 숙취

### A. 두통·민감형
- 권장 환경: 샤워
- 온도: 미지근~중간
- 행동 힌트: 짧은 루틴
- 마무리: 급격한 온도 변화 금지

### B. 몸 무거움형
- 권장 환경: 샤워/욕조
- 온도 패턴: 중간 유지
- 행동 힌트: 리듬 전환 1회 포함
- 마무리: 단계적 정리

## 5.8 우울 (기분 저하)

### A. 무기력형
- 권장 환경: 샤워/욕조
- 온도 패턴: 중간 → 살짝 하향
- 행동 힌트: 리듬 전환 1회
- 마무리: 밝기 소폭 증가

### B. 감정 침잠형
- 권장 환경: 욕조
- 온도: 중간
- 행동 힌트: 서사·몰입 강조
- 마무리: 단계적 정리

## 6. 기존 프로토콜과 충돌 관리

## 6.1 우선순위 (고정)

```txt
1) Safety Filter
2) User-selected Environment
3) Care Branching Recommendation
4) Commerce/Product Matching
```

## 6.2 충돌 매트릭스

| 충돌 상황 | 처리 규칙 |
|---|---|
| 분기 권장 환경과 사용자 선택 환경이 다름 | 사용자 선택 유지, 분기 권장은 대체안으로 표기 |
| 분기 온도가 Safety 상한을 초과 | Safety 상한으로 강제 하향 |
| 분기 행동이 고위험군과 충돌 | 행동 힌트 제거 + 안전 대체 힌트 노출 |
| sleep/recovery/reset 기본 모드와 분기 제안 불일치 | 기존 ModeProtocol 유지, 분기 힌트는 보조 정보로 적용 |
| Reset 관련 냉수 제안이 금기군과 충돌 | `RESET_WITHOUT_COLD` 규칙 유지, 냉수 경로 완전 차단 |

## 7. 제품 추천 연동 원칙 (문서 레벨)

- 본 RFC는 알고리즘 문서지만, 추후 연동 기준은 다음으로 고정한다.
  - 상태+subtype 키(`care_primary_state + care_subtype`)로 Slot A 후보 우선순위 조정
  - Slot 규칙(A/B/C) 자체는 현행 유지
  - Safety와 환경 필터를 통과한 후보만 분기 가중치 적용

## 8. 적용 게이트 (머지 조건)

아래 조건 충족 전까지 PRD 본문 규격으로 승격하지 않는다.

1. 충돌 매트릭스 합의 완료  
2. 상태 8개 × subtype A/B 테스트 케이스 정의 완료  
3. Safety 우선 규칙 자동화 테스트 가능 여부 확인  
4. UI 미반영 원칙 유지(화면 변경 PR 별도 분리)

## 9. 오픈 이슈

1. subtype 미선택 시 fallback 정책
- 후보: 기본 A 적용 vs 추가 확인 질문

2. 사용자 환경과 권장 환경 불일치 시 메시지 톤
- 경고형 vs 제안형

3. 제품 슬롯 즉시 연동 범위
- Slot A만 우선 vs A/B/C 전체 동기화

---

본 문서는 구현 지시서가 아니라 충돌 방지용 설계 RFC다.  
실제 코드 반영은 별도 Implementation Plan과 테스트 명세 승인 후 진행한다.
